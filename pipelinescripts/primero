pipeline {
    agent any
    
    stages {
        
        stage('Get Code') {
            steps {
                git 'https://github.com/anieto-unir/helloworld.git'
            }
        }
        
        stage('Build') {
            steps {
                echo 'En python no hay que compilar nada'
                echo WORKSPACE
                echo 'ls -la'
            }
        }
        
        stage('Tests') {
            parallel {
               stage('Unit') {
                   steps {
                       catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                           sh '''
                             export PYTHONPATH=$WORKSPACE
                             pytest --junitxml=result-unit.xml test/unit
                             '''
                       }
                   }
               }
               stage('Service') {
                  steps {
                    sh '''
                      export FLASK_APP=app/api.py
                      flask run &
                      java -jar /opt/wiremock/wiremock-standalone.jar \
                        --port 9090 \
                        --root-dir test/wiremock &
                        
                      # Espera a que WireMock esté listo (hasta 15s)
                      for i in $(seq 1 15); do
                        if curl -sSf http://127.0.0.1:9090/__admin >/dev/null; then
                          echo "WireMock listo en 9090"
                          break
                        fi
                        sleep 1
                      done
                
                      # Si no está listo, sacamos log y fallamos
                      curl -sSf http://127.0.0.1:9090/__admin >/dev/null || {
                        echo "WireMock NO arrancó. Log:";
                        tail -n 200 wiremock.log || true
                        kill "$WIREMOCK_PID" || true
                        exit 1
                      }
                
                      export PYTHONPATH="$WORKSPACE"
                      pytest --junitxml=result-rest.xml test/rest
                    '''
                  }
                }       
            }
        }
        
        stage('Results') {
            steps {
                junit 'result*.xml'
            }
        }
        
    }
}pipeline {
    agent any
    
    stages {
        
        stage('Get Code') {
            steps {
                git 'https://github.com/anieto-unir/helloworld.git'
            }
        }
        
        stage('Build') {
            steps {
                echo 'En python no hay que compilar nada'
                echo WORKSPACE
                echo 'ls -la'
            }
        }
        
        stage('Tests') {
            parallel {
               stage('Unit') {
                   steps {
                       catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                           sh '''
                             export PYTHONPATH=$WORKSPACE
                             pytest --junitxml=result-unit.xml test/unit
                             '''
                       }
                   }
               }
               stage('Service') {
                  steps {
                    sh '''
                      export FLASK_APP=app/api.py
                      flask run &
                      java -jar /opt/wiremock/wiremock-standalone.jar \
                        --port 9090 \
                        --root-dir test/wiremock &
                        
                      # Espera a que WireMock esté listo (hasta 15s)
                      for i in $(seq 1 15); do
                        if curl -sSf http://127.0.0.1:9090/__admin >/dev/null; then
                          echo "WireMock listo en 9090"
                          break
                        fi
                        sleep 1
                      done
                
                      # Si no está listo, sacamos log y fallamos
                      curl -sSf http://127.0.0.1:9090/__admin >/dev/null || {
                        echo "WireMock NO arrancó. Log:";
                        tail -n 200 wiremock.log || true
                        kill "$WIREMOCK_PID" || true
                        exit 1
                      }
                
                      export PYTHONPATH="$WORKSPACE"
                      pytest --junitxml=result-rest.xml test/rest
                    '''
                  }
                }       
            }
        }
        
        stage('Results') {
            steps {
                junit 'result*.xml'
            }
        }
        
    }
}
