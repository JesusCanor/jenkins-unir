FROM jenkins/inbound-agent:latest-jdk21

USER root

#System dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl ca-certificates git tar \
    python3 python3-pip \
 && rm -rf /var/lib/apt/lists/*

# Python dependencies
COPY basicRequirements.txt /tmp/requirements.txt
RUN pip3 install --no-cache-dir --break-system-packages -r /tmp/requirements.txt

ARG JMETER_VERSION=5.6.3
#Jmeter installation
RUN mkdir -p /opt/jmeter \
 && curl -fsSL "https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz" -o /tmp/jmeter.tgz \
 && tar -xzf /tmp/jmeter.tgz -C /opt/jmeter --strip-components=1 \
 && rm /tmp/jmeter.tgz \
 && ln -sfn /opt/jmeter/bin/jmeter /usr/local/bin/jmeter \
 && chown -R jenkins:jenkins /opt/jmeter

USER jenkins
