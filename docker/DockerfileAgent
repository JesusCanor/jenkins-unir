FROM python:3.12-slim

USER root
RUN apt-get update && apt-get install -y --no-install-recommends \
   openssh-server \
   openjdk-21-jre-headless \
   git curl ca-certificates \
&& rm -rf /var/lib/apt/lists/*

# Usuario "jenkins" para conexi√≥n SSH
RUN useradd -m -s /bin/bash jenkins \
 && echo "jenkins:jenkins" | chpasswd \
 && mkdir -p /home/jenkins/agent \
 && chown -R jenkins:jenkins /home/jenkins

# SSH daemon
RUN mkdir -p /var/run/sshd

#System versions
ARG WIREMOCK_VERSION=2.35.0

# Python dependencies
COPY requirements.txt /tmp/requirements.txt
RUN pip3 install --no-cache-dir --break-system-packages -r /tmp/requirements.txt

#Wiremock jar
RUN mkdir -p /opt/wiremock \
 && curl -fsSL -o /opt/wiremock/wiremock-standalone.jar \
    "https://repo1.maven.org/maven2/com/github/tomakehurst/wiremock-jre8-standalone/${WIREMOCK_VERSION}/wiremock-jre8-standalone-${WIREMOCK_VERSION}.jar"

EXPOSE 22
CMD ["bash", "-lc", "ssh-keygen -A && /usr/sbin/sshd -D -e"]
